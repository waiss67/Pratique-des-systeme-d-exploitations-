#!/bin/sh
#groupe : BAQUI Waiss, BISCH Geoffrey
#liste erreur:
#exit 1: trop ou pas assez d'arguments
#exit 2: utilisation de CTRL+C
#exit 3: mauvaise option
#exit 4: la mesures n'existe pas
temp=/tmp/grapheur$$
trap "echo CTRL+C has been pressed ; rm $temp; exit 2" 2

#vérification de l'existence du fichier
#+suppression de son contenu eventuel
if ! [ -e $temp ]
then
	touch $temp
else
	echo -n "">$temp
fi
#########################################################
#							#
#		Gestion des options			#
# 							#
#########################################################

while getopts "o:" option
do
	case $option in
		o)#output
		output=$OPTARG
		if ! [ $output = *.pdf ]
		then
			output=$output.pdf
		fi
		echo "set output \"$output\"">> $temp
		echo "set terminal pdf">>$temp
		;;
		\?)
			echo "Usage:">&2
			echo "-o to change output in pdf format">&2
			echo "+ 1 or 2 args correspond to the measure to draw">&2
			exit 3
			;;
	esac
done
shift $(($OPTIND -1));

#########################################################
#							#
#		Controle des arguments			#
#							#
#########################################################

if [ $# -eq 0 -o $# -gt 2 ]
then
	echo "Usage: $0 need at least 1 args and max 2 args">&2
	exit 1
fi

for f in $*
do
	if ! [ -f $f ]
	then
		echo "$f doesn't exist as measure files">&2
		exit 4
	fi
done

#########################################################
#							#
#		création du graphique			#
#							#
#########################################################

#paramettre de base a gnuplot
echo "set xdata time" >> $temp
echo "set datafile separator \"\t"\">>$temp
echo "set timefmt \"%Y-%m-%d %H:%M:%S\"">>$temp
echo "set format x \"%m/%d %H:%M:%S\"">>$temp
echo "set xtics rotate">>$temp
echo "set ylabel \"$(head -n 1 $1)\"">>$temp

#paramettre personnalisé en fonction du nombre de mesure a afficher
if [ $# -eq 2 ]
then
	echo "set y2tics">>$temp
	echo "set y2label \"$(head -n 1 $2)\"">>$temp
	echo "plot \"$1\" using 1:2 with lines axes x1y1, \"$2\" using 1:2 with lines axes x1y2">>$temp
else
	echo "plot \"$1\" using 1:2 with lines axes x1y1">>$temp
fi
echo "pause -1">>$temp

gnuplot "$temp"
rm $temp

exit 0
